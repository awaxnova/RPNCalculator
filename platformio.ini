[platformio]
default_envs = esp32_debug
description = ESP32-32E + ST7796S(320x480) + XPT2046 touch + LVGL

[env]
platform = espressif32@6.6.0
framework = arduino
board = esp32dev
board_build.flash_mode = qio
board_build.filesystem = littlefs
board_build.partitions = partitions/app_fs_4MB.csv
monitor_speed = 115200
upload_speed = 921600

; Helpful output in the serial monitor
monitor_filters = esp32_exception_decoder, time

; Make PIO scan libraries more thoroughly (LVGL)
lib_ldf_mode = deep+
lib_archive = yes

lib_deps =
  bodmer/TFT_eSPI @ ^2.5.43
  lvgl/lvgl @ ^9.2.0
  bblanchon/ArduinoJson @ ^7.1.0

; Generate a version header at build time
extra_scripts = scripts/version_header.py

; ==== Display/Touch/SD Wiring (your board) ====
; LCD on HSPI: MOSI=13, MISO=12, SCLK=14, CS=15, DC=2, RST tied to EN (-1), BL=27
; Touch XPT2046: CS=33, IRQ=36 (same HSPI bus)
; SD on VSPI default: CS=5 (CLK=18, MOSI=23, MISO=19)

; Notes:
; - We feed TFT_eSPI entirely via build_flags (USER_SETUP_LOADED).
; - LVGL looks for lv_conf.h on include path; we set LV_CONF_INCLUDE_SIMPLE.

build_flags =
  -D LV_CONF_PATH=\"lv_conf.h\"
  -D SERIAL_BAUD=115200
  -D CORE_DEBUG_LEVEL=1

  ; ---- LVGL config ----
  -D LV_CONF_INCLUDE_SIMPLE

  ; ---- TFT_eSPI driver (ST7796S) ----
  -D USER_SETUP_LOADED
  -D ST7796_DRIVER
  -D TFT_RGB_ORDER=0             ; 0=RGB, 1=BGR (flip if colors look wrong)
  -D TFT_SPI_PORT=HSPI
  -D SPI_FREQUENCY=40000000
  -D SPI_READ_FREQUENCY=16000000
  -D SPI_TOUCH_FREQUENCY=2500000

  ; LCD pins
  -D TFT_MOSI=13
  -D TFT_MISO=12
  -D TFT_SCLK=14
  -D TFT_CS=15
  -D TFT_DC=2
  -D TFT_RST=-1                  ; tied to EN
  -D TFT_BL=27
  -D TFT_BACKLIGHT_ON=HIGH

  ; Touch pins (XPT2046)
  -D TOUCH_CS=33
  -D TOUCH_IRQ=36

  ; SD card (VSPI default pins with this CS)
  -D SD_CS=5

[env:esp32_debug]
build_type = debug
; Ensure no -Os sneaks in
build_unflags = -Os
build_flags =
  ${env.build_flags}
  -D BUILD_FLAVOR_DEBUG
  -Og -g3 -fno-inline

[env:esp32_release]
build_type = release
build_flags =
  ${env.build_flags}
  -D BUILD_FLAVOR_RELEASE
  -O2
